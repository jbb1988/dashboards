<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MARS Contract Review</title>
  <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1f2e;
      color: #fff;
      min-height: 100vh;
    }
    .container { padding: 16px; }
    .header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 16px;
      border-bottom: 1px solid #2d3548;
      margin-bottom: 16px;
    }
    .header svg { width: 24px; height: 24px; color: #818cf8; }
    .header h1 { font-size: 16px; font-weight: 600; }
    .user-info {
      font-size: 12px;
      color: #64748b;
      margin-bottom: 16px;
    }
    .btn {
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #6366f1;
      color: white;
    }
    .btn-primary:hover { background: #4f46e5; }
    .btn-primary:disabled {
      background: #4b5563;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #374151;
      color: #e5e7eb;
      margin-top: 8px;
    }
    .btn-secondary:hover { background: #4b5563; }
    .login-card {
      text-align: center;
      padding: 40px 20px;
    }
    .login-card svg {
      width: 48px;
      height: 48px;
      color: #6366f1;
      margin-bottom: 16px;
    }
    .login-card h2 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    .login-card p {
      font-size: 13px;
      color: #64748b;
      margin-bottom: 24px;
    }
    .results { margin-top: 20px; }
    .score-card {
      background: #242937;
      border-radius: 12px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 16px;
    }
    .score-circle {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 700;
    }
    .score-low { background: #14532d; color: #4ade80; }
    .score-medium { background: #78350f; color: #fbbf24; }
    .score-high { background: #7f1d1d; color: #f87171; }
    .score-info h3 { font-size: 14px; font-weight: 500; }
    .score-info p { font-size: 12px; color: #64748b; }
    .summary {
      background: #242937;
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      color: #94a3b8;
      margin-bottom: 16px;
      line-height: 1.5;
    }
    .risks-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .risk-item {
      background: #242937;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }
    .risk-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .risk-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    .risk-badge.high { background: #7f1d1d; color: #fca5a5; }
    .risk-badge.medium { background: #78350f; color: #fcd34d; }
    .risk-badge.low { background: #14532d; color: #86efac; }
    .risk-title { font-size: 13px; font-weight: 500; }
    .risk-desc {
      font-size: 12px;
      color: #94a3b8;
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .risk-suggestion {
      background: #1a1f2e;
      padding: 8px;
      border-radius: 4px;
      font-size: 12px;
      color: #a5b4fc;
      margin-bottom: 8px;
    }
    .risk-actions { display: flex; gap: 8px; }
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }
    .btn-insert {
      background: #6366f1;
      color: white;
    }
    .btn-highlight {
      background: #374151;
      color: #e5e7eb;
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error {
      background: #7f1d1d;
      color: #fca5a5;
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 16px;
    }
    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      background: #242937;
      padding: 4px;
      border-radius: 8px;
    }
    .tab {
      flex: 1;
      padding: 8px;
      border: none;
      background: transparent;
      color: #64748b;
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
    }
    .tab.active {
      background: #6366f1;
      color: white;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
      <h1>MARS Contract Review</h1>
    </div>

    <!-- Login View -->
    <div id="loginView" class="login-card">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
      <h2>Welcome</h2>
      <p>Sign in with your Microsoft account to analyze contracts</p>
      <button class="btn btn-primary" onclick="signIn()">
        Sign in with Microsoft
      </button>
    </div>

    <!-- Main View -->
    <div id="mainView" class="hidden">
      <div class="user-info" id="userInfo"></div>

      <div class="tabs">
        <button class="tab active" onclick="showTab('analyze', this)">Analyze</button>
        <button class="tab" onclick="showTab('clauses', this)">Clauses</button>
      </div>

      <!-- Analyze Tab -->
      <div id="analyzeTab">
        <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeDocument()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          Analyze Document
        </button>

        <div id="error" class="error hidden"></div>
        <div id="results" class="results hidden"></div>
      </div>

      <!-- Clauses Tab -->
      <div id="clausesTab" class="hidden">
        <button class="btn btn-secondary" onclick="loadClauses()">
          Load Clause Library
        </button>
        <div id="clausesList" style="margin-top: 16px;"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://mars-contracts.vercel.app';
    let currentUser = null;

    // Initialize Office
    Office.onReady(function() {
      console.log('Office.js ready');
      checkAuth();
    });

    // Check if user is logged in
    function checkAuth() {
      const token = localStorage.getItem('mars_addin_token');
      const user = localStorage.getItem('mars_addin_user');
      if (token && user) {
        currentUser = JSON.parse(user);
        showMainView();
      }
    }

    // Sign in
    function signIn() {
      const clientId = '096cefd5-eed8-4b07-ba99-b57b775735d4';
      const redirectUri = encodeURIComponent(API_BASE + '/word-addin/auth-callback.html');
      const scope = encodeURIComponent('openid profile email User.Read');

      const authUrl = 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=' + clientId + '&response_type=code&redirect_uri=' + redirectUri + '&scope=' + scope + '&response_mode=query';

      // Open auth dialog
      Office.context.ui.displayDialogAsync(authUrl, {height: 60, width: 30}, function(result) {
        if (result.status === Office.AsyncResultStatus.Succeeded) {
          var dialog = result.value;
          dialog.addEventHandler(Office.EventType.DialogMessageReceived, function(args) {
            var message = JSON.parse(args.message);
            if (message.type === 'auth_success') {
              localStorage.setItem('mars_addin_token', message.token);
              localStorage.setItem('mars_addin_user', JSON.stringify(message.user));
              currentUser = message.user;
              dialog.close();
              showMainView();
            } else if (message.type === 'auth_error') {
              showError(message.error);
              dialog.close();
            }
          });
        }
      });
    }

    // Show main view after login
    function showMainView() {
      document.getElementById('loginView').classList.add('hidden');
      document.getElementById('mainView').classList.remove('hidden');
      document.getElementById('userInfo').textContent = 'Signed in as: ' + currentUser.email;
    }

    // Show/hide tabs
    function showTab(tab, btn) {
      document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
      btn.classList.add('active');

      if (tab === 'analyze') {
        document.getElementById('analyzeTab').classList.remove('hidden');
        document.getElementById('clausesTab').classList.add('hidden');
      } else {
        document.getElementById('analyzeTab').classList.add('hidden');
        document.getElementById('clausesTab').classList.remove('hidden');
      }
    }

    // Get document text
    function getDocumentText() {
      return new Promise(function(resolve, reject) {
        Word.run(function(context) {
          var body = context.document.body;
          body.load('text');
          return context.sync().then(function() {
            resolve(body.text);
          });
        }).catch(reject);
      });
    }

    // Analyze document
    function analyzeDocument() {
      var btn = document.getElementById('analyzeBtn');
      var resultsDiv = document.getElementById('results');
      var errorDiv = document.getElementById('error');

      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Analyzing...';
      errorDiv.classList.add('hidden');
      resultsDiv.classList.add('hidden');

      getDocumentText().then(function(text) {
        if (!text || text.trim().length < 100) {
          throw new Error('Document is too short to analyze (minimum 100 characters)');
        }

        var token = localStorage.getItem('mars_addin_token');
        return fetch(API_BASE + '/api/word-addin/analyze', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ document_text: text })
        });
      }).then(function(response) {
        if (!response.ok) {
          return response.json().then(function(err) {
            throw new Error(err.error || 'Analysis failed');
          });
        }
        return response.json();
      }).then(function(result) {
        displayResults(result);
      }).catch(function(err) {
        showError(err.message);
      }).finally(function() {
        btn.disabled = false;
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg> Analyze Document';
      });
    }

    // Display analysis results
    function displayResults(result) {
      var resultsDiv = document.getElementById('results');

      var scoreClass = result.risk_level === 'high' ? 'score-high' :
                       result.risk_level === 'medium' ? 'score-medium' : 'score-low';

      var html = '<div class="score-card">' +
        '<div class="score-circle ' + scoreClass + '">' + Math.round(result.overall_risk_score) + '</div>' +
        '<div class="score-info">' +
        '<h3>Risk Score</h3>' +
        '<p>' + result.risk_level.charAt(0).toUpperCase() + result.risk_level.slice(1) + ' Risk</p>' +
        '</div></div>' +
        '<div class="summary">' + result.summary + '</div>';

      if (result.risks && result.risks.length > 0) {
        html += '<div class="risks-title">Issues Found (' + result.risks.length + ')</div>';
        result.risks.forEach(function(risk) {
          html += '<div class="risk-item">' +
            '<div class="risk-header">' +
            '<span class="risk-badge ' + risk.severity + '">' + risk.severity + '</span>' +
            '<span class="risk-title">' + risk.title + '</span>' +
            '</div>' +
            '<div class="risk-desc">' + risk.description + '</div>';
          if (risk.suggestion) {
            var escapedSuggestion = risk.suggestion.replace(/'/g, "\\'").replace(/\n/g, '\\n');
            html += '<div class="risk-suggestion">Suggestion: ' + risk.suggestion + '</div>' +
              '<div class="risk-actions">' +
              '<button class="btn-small btn-insert" onclick="insertText(\'' + escapedSuggestion + '\')">Insert</button>';
            if (risk.location) {
              var escapedLocation = risk.location.replace(/'/g, "\\'");
              html += '<button class="btn-small btn-highlight" onclick="highlightText(\'' + escapedLocation + '\')">Find</button>';
            }
            html += '</div>';
          }
          html += '</div>';
        });
      }

      resultsDiv.innerHTML = html;
      resultsDiv.classList.remove('hidden');
    }

    // Insert text at cursor
    function insertText(text) {
      Word.run(function(context) {
        var selection = context.document.getSelection();
        selection.insertText(text, Word.InsertLocation.replace);
        return context.sync();
      }).catch(function(err) {
        showError('Failed to insert text');
      });
    }

    // Highlight/find text in document
    function highlightText(text) {
      Word.run(function(context) {
        var results = context.document.body.search(text.substring(0, 50), {matchCase: false});
        results.load('items');
        return context.sync().then(function() {
          if (results.items.length > 0) {
            results.items[0].font.highlightColor = '#FFE066';
            results.items[0].select();
            return context.sync();
          }
        });
      }).catch(function(err) {
        console.error('Highlight failed:', err);
      });
    }

    // Load clauses
    function loadClauses() {
      var listDiv = document.getElementById('clausesList');
      listDiv.innerHTML = '<div class="spinner"></div> Loading...';

      var token = localStorage.getItem('mars_addin_token');
      fetch(API_BASE + '/api/word-addin/clauses', {
        headers: { 'Authorization': 'Bearer ' + token }
      }).then(function(response) {
        return response.json();
      }).then(function(data) {
        if (!data.clauses || data.clauses.length === 0) {
          listDiv.innerHTML = '<p style="color: #64748b; font-size: 13px;">No clauses found. Add clauses in the MARS web app.</p>';
          return;
        }

        var html = '';
        data.clauses.forEach(function(clause) {
          var escapedText = clause.primary_text.replace(/'/g, "\\'").replace(/\n/g, '\\n');
          html += '<div class="risk-item">' +
            '<div class="risk-header">' +
            '<span class="risk-badge ' + clause.risk_level + '">' + clause.risk_level + '</span>' +
            '<span class="risk-title">' + clause.name + '</span>' +
            '</div>' +
            '<div class="risk-desc">' + clause.primary_text.substring(0, 150) + '...</div>' +
            '<div class="risk-actions">' +
            '<button class="btn-small btn-insert" onclick="insertText(\'' + escapedText + '\')">Insert</button>' +
            '</div></div>';
        });
        listDiv.innerHTML = html;
      }).catch(function(err) {
        listDiv.innerHTML = '<p style="color: #f87171;">Failed to load clauses</p>';
      });
    }

    // Show error
    function showError(message) {
      var errorDiv = document.getElementById('error');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
    }
  </script>
</body>
</html>
